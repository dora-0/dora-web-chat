$(function(){const e=["#e21400","#91580f","#f8a700","#f78b00","#58dc00","#287b00","#a8f07a","#4ae8c4","#3b88eb","#3824aa","#a700ff","#d300e7"],n=$(window),t=$(".usernameInput"),s=$("#usernameMsg"),o=$(".messages"),a=$(".inputMessage"),i=$(".login.page"),r=$(".chat.page");var c,l,m=!1,u=!1,d=t.focus();const f=io("https://chat.mandora.xyz"),p=()=>(Notification.requestPermission().then(e=>{"granted"!==e&&console.warn("Notification 권한 획득에 실패했습니다.")}),"granted"===Notification.permission),g=e=>{var n=$(".username");n.unbind("click.AutoMention"),n.bind("click.AutoMention",function(){var n=e.username;a.val(a.val()+"@"+n+" ")})},v=e=>{var n="";n+="현재 "+e.numUsers+"명이 접속 중입니다.",y(n)},h=()=>{var e=a.val();if((e=C(e))&&m){a.val("");const n={username:c,message:e};w(n),f.emit("new message",e),g(n)}},y=(e,n)=>{const t=$("<li>").addClass("log").text(e);k(t,n)},w=(e,n)=>{const t=I(e);if(n=n||{},0!==t.length&&(n.fade=!1,t.remove()),e.message.includes("@"+c+" ")&&(e.color="red",window.Notification&&p())){var s={body:e.message,icon:"/favicon.ico"};try{new Notification(e.username,s)}catch(e){console.warn("Warning: Not supported for this platform")}}var o=e.ipaddr;o=void 0===o||null==o||""===o?"":"("+o+")";const a=$('<span class="username"/>').text(e.username+o).css("color",x(e.username)),i=$('<span class="messageBody">').text(e.message).css("color",e.color),r=e.typing?"typing":"",l=$('<li class="message"/>').data("username",e.username).addClass(r).append(a,i);k(l,n)},b=e=>{I(e).fadeOut(function(){$(this).remove()})},k=(e,n)=>{const t=$(e);n||(n={}),void 0===n.fade&&(n.fade=!0),void 0===n.prepend&&(n.prepend=!1),n.fade&&t.hide().fadeIn(150),n.prepend?o.prepend(t):o.append(t),o[0].scrollTop=o[0].scrollHeight},C=e=>$("<div/>").text(e).html(),I=e=>$(".typing.message").filter(function(n){return $(this).data("username")===e.username}),x=n=>{for(var t=7,s=0;s<n.length;s++)t=n.charCodeAt(s)+(t<<5)-t;const o=Math.abs(t%e.length);return e[o]};function N(){if(c)h(),f.emit("stop typing"),u=!1;else if("hidden"!==t.attr("type")){const e=C(t.val().trim());e&&(s.css("color","white"),s.text("닉네임 중복 검사 중 ..."),f.emit("verify user",{username:e,require_task:"storeClientInfo"}))}else{const e=C(t.val().trim());e&&f.emit("storeClientInfo",{username:e,user_type:"member"})}}n.keydown(e=>{e.ctrlKey||e.metaKey||e.altKey||d.focus(),13===e.which&&N()}),a.on("input",()=>{m&&(u||(u=!0,f.emit("typing")),l=(new Date).getTime(),setTimeout(()=>{(new Date).getTime()-l>=400&&u&&(f.emit("stop typing"),u=!1)},400))}),i.click(()=>{d.focus(),N()}),a.click(()=>{a.focus()}),f.on("login",e=>{m=!0;y("서버에 연결되었습니다! - Welcome to Socket.IO Chat Server",{prepend:!0}),v(e),p()}),f.on("verify user",e=>{if(!1===e.verified)s.css("color","yellow"),s.html("이미 사용 중인 닉네임이거나 다른 세션에서 접속 중입니다.<br/>다시 시도해 보세요.");else if(!0===e.verified&&"storeClientInfo"===e.require_task){const e=C(t.val().trim());e&&f.emit("storeClientInfo",{username:e,user_type:"guest"})}else(c=C(t.val().trim()))&&(i.fadeOut(),r.show(),i.off("click"),d=a.focus(),f.emit("add user",c))}),f.on("new message",e=>{w(e),g(e)}),f.on("user joined",e=>{y(e.username+"님이 들어왔습니다."),v(e)}),f.on("user left",e=>{y(e.username+"님이 나갔습니다."),v(e),b(e)}),f.on("typing",e=>{(e=>{e.typing=!0,e.message="님이 입력하는 중 ...",w(e)})(e)}),f.on("stop typing",e=>{b(e)}),f.on("disconnect",()=>{y("연결이 해제되었습니다.")}),f.on("reconnect",()=>{y("서버에 다시 연결되었습니다!"),c&&f.emit("add user",c)}),f.on("reconnect_error",()=>{y("서버 연결에 실패했습니다. 잠시 후 다시 연결을 시도합니다 ...")})});