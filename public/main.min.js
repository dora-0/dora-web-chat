$(function(){const e=["#e21400","#91580f","#f8a700","#f78b00","#58dc00","#287b00","#a8f07a","#4ae8c4","#3b88eb","#3824aa","#a700ff","#d300e7"],t=$(window),n=$(".usernameInput"),s=$("#usernameMsg"),o=$(".messages"),i=$(".inputMessage"),a=$(".login.page"),r=$(".chat.page");var c,l,m=!1,u=!1,d=n.focus();const f=io("https://chat.mandora.xyz"),p=()=>(Notification.requestPermission().then(e=>{"granted"!==e&&console.warn("Notification 권한 획득에 실패했습니다.")}),"granted"===Notification.permission),g=e=>{var t=$(".username");t.unbind("click.AutoMention"),t.bind("click.AutoMention",function(){var e=$(this).text().split("(")[0];i.val(i.val()+"@"+e+" ")})},v=e=>{var t="";t+="현재 "+e.numUsers+"명이 접속 중입니다.",y(t)},h=()=>{var e=i.val();if((e=C(e))&&m){i.val("");const t={username:c,message:e};w(t),f.emit("new message",e),g()}},y=(e,t)=>{const n=$("<li>").addClass("log").text(e);k(n,t)},w=(e,t)=>{const n=x(e);if(t=t||{},0!==n.length&&(t.fade=!1,n.remove()),e.message.includes("@"+c+" ")&&(e.color="red",window.Notification&&p())){var s={body:e.message,icon:"/favicon.ico"};try{new Notification(e.username,s)}catch(e){console.warn("Warning: Not supported for this platform")}}var o=e.ipaddr;o=void 0===o||null==o||""===o?"":"("+o+")";const i=$('<span class="username"/>').text(e.username+o).css("color",I(e.username)),a=$('<span class="messageBody">').text(e.message).css("color",e.color),r=e.typing?"typing":"",l=$('<li class="message"/>').data("username",e.username).addClass(r).append(i,a);k(l,t)},b=e=>{x(e).fadeOut(function(){$(this).remove()})},k=(e,t)=>{const n=$(e);t||(t={}),void 0===t.fade&&(t.fade=!0),void 0===t.prepend&&(t.prepend=!1),t.fade&&n.hide().fadeIn(150),t.prepend?o.prepend(n):o.append(n),o[0].scrollTop=o[0].scrollHeight},C=e=>$("<div/>").text(e).html(),x=e=>$(".typing.message").filter(function(t){return $(this).data("username")===e.username}),I=t=>{for(var n=7,s=0;s<t.length;s++)n=t.charCodeAt(s)+(n<<5)-n;const o=Math.abs(n%e.length);return e[o]};function N(){if(c)h(),f.emit("stop typing"),u=!1;else if("hidden"!==n.attr("type")){const e=C(n.val().trim());e&&!/[\{\}\[\]\/?.,;:|\)*~`!^\-+<>@\#$%&\\\=\(\'\"]/gi.test(e)&&(s.css("color","white"),s.text("닉네임 중복 검사 중 ..."),f.emit("verify user",{username:e,require_task:"storeClientInfo"}))}else{const e=C(n.val().trim());e&&f.emit("storeClientInfo",{username:e,user_type:"member"})}}t.keydown(e=>{e.ctrlKey||e.metaKey||e.altKey||d.focus(),13===e.which&&N()}),i.on("input",()=>{m&&(u||(u=!0,f.emit("typing")),l=(new Date).getTime(),setTimeout(()=>{(new Date).getTime()-l>=400&&u&&(f.emit("stop typing"),u=!1)},400))}),a.click(()=>{d.focus(),N()}),i.click(()=>{i.focus()}),f.on("login",e=>{m=!0;y("서버에 연결되었습니다! - Welcome to Socket.IO Chat Server",{prepend:!0}),v(e),p()}),f.on("verify user",e=>{if(!1===e.verified)s.css("color","yellow"),s.html("이미 사용 중인 닉네임이거나 다른 세션에서 접속 중입니다.<br/>다시 시도해 보세요.");else if(!0===e.verified&&"storeClientInfo"===e.require_task){const e=C(n.val().trim());e&&f.emit("storeClientInfo",{username:e,user_type:"guest"})}else(c=C(n.val().trim()))&&(a.fadeOut(),r.show(),a.off("click"),d=i.focus(),f.emit("add user",c))}),f.on("new message",e=>{w(e),g()}),f.on("user joined",e=>{y(e.username+"님이 들어왔습니다."),v(e)}),f.on("user left",e=>{y(e.username+"님이 나갔습니다."),v(e),b(e)}),f.on("typing",e=>{(e=>{e.typing=!0,e.message="님이 입력하는 중 ...",w(e)})(e)}),f.on("stop typing",e=>{b(e)}),f.on("disconnect",()=>{y("연결이 해제되었습니다.")}),f.on("reconnect",()=>{y("서버에 다시 연결되었습니다!"),c&&f.emit("add user",c)}),f.on("reconnect_error",()=>{y("서버 연결에 실패했습니다. 잠시 후 다시 연결을 시도합니다 ...")})});